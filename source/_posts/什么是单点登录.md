---
title: 什么是单点登录
date: 2020-06-21 11:02:05
tags:
    - 安全功能
---

单点登录英文全称Single Sign On，简称就是SSO。它的解释是：在多个应用系统中，只需要登录一次，就可以访问其他相互信任的应用系统。

# 概念

SSO（ Single Sign-On ），中文意即单点登录，翻译得比较精简。单点登录是一种控制多个相关但彼此独立的系统的访问权限, 拥有这一权限的用户可以使用单一的ID和密码访问某个或多个系统从而避免使用不同的用户名或密码，或者通过某种配置无缝地登录每个系统)。

<!--more-->
 
OK，从上面的定义中我们总结出 与 SSO 交互的2个元素：1.  用户，2. 系统，
它的特点是：一次登录，全部访问。
上面提到SSO是访问控制的一种，控制用户能否登录，即验证用户身份，而且是所有其它系统的身份验证都在它这里进行，那么我们是不是可以认为SSO还是一个验证中心。那么从整个系统层面来看SSO，它的核心就是这3个元素了：1. 用户，2. 系统，3. 验证中心。可能扯了那么多还是不足以形象地描述我们萌萌的SSO，有图有真相：

![单点登录概念](单点登录概念.png)

既然SSO这么棒，应该如何实现呢？

# 原理

## 1、登录
相比于单系统登录，sso需要一个独立的认证中心，只有认证中心能接受用户的用户名密码等安全信息，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，sso认证中心验证用户的用户名密码没问题，创建授权令牌，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌，即得到了授权，可以借此创建局部会话，局部会话登录方式与单系统的登录方式相同。这个过程，也就是单点登录的原理，用下图说明

![单点登录原理-登录](单点登录原理-登录.png)

* <font size=4>下面对上图简要描述</font>

1.用户访问系统1的受保护资源，系统1发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
2.sso认证中心发现用户未登录，将用户引导至登录页面
3.用户输入用户名密码提交登录申请
4.sso认证中心校验用户信息，创建用户与sso认证中心之间的会话，称为全局会话，同时创建授权令牌
5.sso认证中心带着令牌跳转会最初的请求地址（系统1）
6.系统1拿到令牌，去sso认证中心校验令牌是否有效
7.sso认证中心校验令牌，返回有效，注册系统1
8.系统1使用该令牌创建与用户的会话，称为局部会话，返回受保护资源
9.用户访问系统2的受保护资源
10.系统2发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
11.sso认证中心发现用户已登录，跳转回系统2的地址，并附上令牌
12.系统2拿到令牌，去sso认证中心校验令牌是否有效
13.sso认证中心校验令牌，返回有效，注册系统2
14.系统2使用该令牌创建与用户的局部会话，返回受保护资源

用户登录成功之后，会与sso认证中心及各个子系统建立会话，用户与sso认证中心建立的会话称为全局会话，用户与各个子系统建立的会话称为局部会话，局部会话建立之后，用户访问子系统受保护资源将不再通过sso认证中心，全局会话与局部会话有如下约束关系
1.局部会话存在，全局会话一定存在
2.全局会话存在，局部会话不一定存在
3.全局会话销毁，局部会话必须销毁
　　你可以通过博客园、百度、csdn、淘宝等网站的登录过程加深对单点登录的理解，注意观察登录过程中的跳转url与参数

## 2、注销
　　单点登录自然也要单点注销，在一个子系统中注销，所有子系统的会话都将被销毁，用下面的图来说明

![单点登录原理-注销](单点登录原理-注销.png)

sso认证中心一直监听全局会话的状态，一旦全局会话销毁，监听器将通知所有注册系统执行注销操作

* <font size=4>下面对上图简要说明</font>

1.用户向系统1发起注销请求
2.系统1根据用户与系统1建立的会话id拿到令牌，向sso认证中心发起注销请求
3.sso认证中心校验令牌有效，销毁全局会话，同时取出所有用此令牌注册的系统地址
4.sso认证中心向所有注册系统发起注销请求
5.各注册系统接收sso认证中心的注销请求，销毁局部会话
6.sso认证中心引导用户至登录页面

# 部署图

单点登录涉及sso认证中心与众子系统，子系统与sso认证中心需要通信以交换令牌、校验令牌及发起注销请求，因而子系统必须集成sso的客户端，sso认证中心则是sso服务端，整个单点登录过程实质是sso客户端与服务端通信的过程，用下图描述

![部署图](部署图.png)

sso认证中心与sso客户端通信方式有多种，这里以简单好用的httpClient为例，web service、rpc、restful api都可以


# CAS原理

说到单点登录，就肯定会见到这个名词：CAS （Central Authentication Service），下面说说CAS是怎么搞的。
如果已经将登录单独抽取成系统出来，我们还能这样玩。现在我们有两个系统，分别是```www.java3y.com```和```www.java4y.com```，一个```SSOwww.sso.com```。

![CAS-1](CAS-1.png)

首先，用户想要访问系统A ```www.java3y.com```受限的资源(比如说购物车功能，购物车功能需要登录后才能访问)，系统A ```www.java3y.com```发现用户并没有登录，于是重定向到sso认证中心，并将自己的地址作为参数。请求的地址如下：
```
"www.sso.com?service=www.java3y.com"
```
sso认证中心发现用户未登录，将用户引导至登录页面，用户进行输入用户名和密码进行登录，用户与认证中心建立全局会话（生成一份Token，写到Cookie中，保存在浏览器上）

![CAS-2](CAS-2.png)

随后，认证中心重定向回系统A，并把Token携带过去给系统A，重定向的地址如下：
```
"www.java3y.com?token=xxxxxxx"
```
接着，系统A去sso认证中心验证这个Token是否正确，如果正确，则系统A和用户建立局部会话（创建Session）。到此，系统A和用户已经是登录状态了。

![CAS-3](CAS-3.png)

此时，用户想要访问系统B ```www.java4y.com```受限的资源(比如说订单功能，订单功能需要登录后才能访问)，系统B ```www.java4y.com```发现用户并没有登录，于是重定向到sso认证中心，并将自己的地址作为参数。请求的地址如下：
```
?www.sso.com?service=www.java4y.com
```
注意，因为之前用户与认证中心```www.sso.com```已经建立了全局会话（当时已经把Cookie保存到浏览器上了），所以这次系统B重定向到认证中心```www.sso.com```是可以带上Cookie的。
认证中心根据带过来的Cookie发现已经与用户建立了全局会话了，认证中心重定向回系统B，并把Token携带过去给系统B，重定向的地址如下：
```
?www.java4y.com?token=xxxxxxx
```
接着，系统B去sso认证中心验证这个Token是否正确，如果正确，则系统B和用户建立局部会话（创建Session）。到此，系统B和用户已经是登录状态了。

![CAS-4](CAS-4.png)

看到这里，其实SSO认证中心就类似一个中转站。


# 总结

单点登录（SSO系统）是保障各业务系统的用户资源的安全 。

各个业务系统获得的信息是，这个用户能不能访问我的资源。单点登录，资源都在各个业务系统这边，不在SSO那一方。 用户在给SSO服务器提供了用户名密码后，作为业务系统并不知道这件事。 SSO随便给业务系统一个ST，那么业务系统是不能确定这个ST是用户伪造的，还是真的有效，所以要拿着这个ST去SSO服务器再问一下，这个用户给我的ST是否有效，是有效的我才能让这个用户访问。

